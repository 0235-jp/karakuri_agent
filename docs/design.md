# からくりエージェント 設計書

## 1. プロジェクト概要

からくりエージェントは、複数の環境（スマートスピーカー、チャットツール、Webアプリなど）から利用可能なAIエージェントを実現するためのオープンソースプロジェクトです。

### 1.1 主な特徴

- マルチエンドポイント対応（Text/Voice/Video）
- 複数エージェント管理
- 柔軟なLLMモデル選択
- 音声合成(TTS)・音声認識(STT)対応
- 各種サービス連携（LINE等）

## 2. システムアーキテクチャ

### 2.1 全体構成

```
app/
├── api/            # APIエンドポイント
│   └── v1/         # APIバージョン1
├── auth/           # 認証関連
├── core/           # コアロジック
├── schemas/        # データモデル
└── utils/          # ユーティリティ
```

### 2.2 主要コンポーネント

#### 2.2.1 APIエンドポイント (/api/v1/)
- chat.py: テキスト/音声チャット
- line.py: LINE Messaging API連携
- agents.py: エージェント管理
- web_socket.py: WebSocket通信

#### 2.2.2 コアサービス (/core/)
- agent_manager.py: エージェント設定・管理
- llm_service.py: LLMサービス連携
- tts_service.py: 音声合成サービス
- stt_service.py: 音声認識サービス
- memory_service.py: 会話履歴管理
- config.py: 環境設定管理

#### 2.2.3 認証 (/auth/)
- api_key.py: APIキー認証

## 3. 機能詳細

### 3.1 エージェント管理システム

エージェントは環境変数で定義され、以下の要素を含みます：
- 基本情報（ID、名前）
- LLM設定（メッセージ生成、感情生成、画像認識）
- TTS設定（エンドポイント、話者ID等）
- サービス連携設定（LINEチャンネル等）

### 3.2 対応エンドポイント

| エンドポイント | 状態 | 説明 |
|--------------|------|------|
| text to text | ✅ | テキスト入力からテキスト応答 |
| text to voice | ✅ | テキスト入力から音声応答 |
| voice to text | ✅ | 音声入力からテキスト応答 |
| voice to voice | ✅ | 音声入力から音声応答 |

### 3.3 外部サービス連携

#### 3.3.1 LLM (Language Models)
- LiteLLM対応モデル

#### 3.3.2 TTS (Text-to-Speech)
- Voicevox Engine
- AivisSpeech Engine
- にじボイスAPI

#### 3.3.3 STT (Speech-to-Text)
- faster-whisper

#### 3.3.4 メッセージングプラットフォーム
- LINE

## 4. データフロー

### 4.1 基本的な処理フロー

1. クライアントからのリクエスト受信
2. APIキー認証
3. エージェント設定の読み込み
4. 入力形式に応じた前処理
   - テキスト: そのまま処理
   - 音声: STTで変換
   - 画像: Vision LLMで解析
5. LLMによるメッセージ生成
6. 感情生成（必要な場合）
7. 出力形式に応じた後処理
   - テキスト: そのまま返信
   - 音声: TTSで変換
8. レスポンス送信

### 4.2 メモリ管理

- Redisを使用した会話履歴の管理
- 設定可能なトークン使用量の閾値
- 自動的な古い履歴の削除

### 4.3 メモリサービス詳細

#### 4.3.1 会話履歴管理
- データ構造
  ```python
  # キー: conversation_history:{agent_id}
  [
    {
      "role": "user/assistant/system",
      "content": "メッセージ内容"
    }
  ]
  ```
- トークン数管理
  - LiteLLMのtoken_counterを使用したトークン数計算
  - モデルごとのmax_input_tokensに基づく閾値設定
    ```python
    max_tokens = model_cost[model]["max_input_tokens"] or 8192
    threshold = int(max_tokens * threshold_tokens_percentage)  # デフォルト0.8
    ```
  - 閾値超過時の古いメッセージの削除ロジック
    - 最初のユーザーメッセージから次のユーザーメッセージまでを削除

#### 4.3.2 Redisデータモデル
- キー設計
  - 会話履歴: `conversation_history:{agent_id}`
- 同時実行制御
  - asyncio.Lockによる排他制御
  - 会話履歴の更新時にロックを使用
- 実装詳細
  - redis.asyncio非同期クライアントの使用
  - JSON形式でのデータシリアライズ

### 4.4 エラーハンドリング

#### 4.4.1 サービス別エラー対応
- LLMサービス
  - 接続エラー: 最大3回のリトライ
  - レート制限: 指数バックオフによる再試行
  - モデル不使用時: 代替モデルへのフォールバック
- TTS/STTサービス
  - 音声合成エラー: テキスト応答へのフォールバック
  - 音声認識エラー: ユーザーへの再入力リクエスト
- 外部API（LINE等）
  - 一時的な接続エラー: キューイングと再試行
  - 認証エラー: 管理者への通知

#### 4.4.2 リカバリー戦略
- リトライポリシー
  ```python
  {
    "max_retries": 3,
    "initial_delay": 1,  # 秒
    "max_delay": 10,     # 秒
    "backoff_factor": 2
  }
  ```
- エラー通知
  - ログレベルに応じた通知設定
  - クリティカルエラー時の即時通知
  - エラー集計とレポート生成

## 5. 設定管理

### 5.1 環境変数

主な設定項目：
- APIキー
- 音声ファイル管理設定
- Redis接続設定
- エージェント固有の設定
  - LLM設定
  - TTS設定
  - 外部サービス連携設定

### 5.2 エージェント設定

各エージェントは以下の要素を設定可能：
- 基本情報（名前、システムプロンプト）
- LLMサービス設定
  - メッセージ生成用
  - 感情生成用
  - 画像認識用
- 音声設定
  - TTSタイプ
  - スピーカーモデル
  - スピーカーID
- サービス連携設定
  - LINEチャンネル情報等

## 6. 拡張性

### 6.1 新規エンドポイント追加

1. `/api/v1/`に新規エンドポイントファイルを作成
2. 必要なスキーマを`/schemas/`に定義
3. `main.py`にルーターを追加

### 6.2 新規サービス連携

1. 対応するサービスクライアントを実装
2. 必要な設定項目を`config.py`に追加
3. エージェント設定に統合

## 7. デプロイメント

### 7.1 必要要件

- Python 3.8以上
- Redis（オプション）
- 外部サービス
  - VoicevoxEngine（TTS用）
  - LLMサービス（OpenAI等）

### 7.2 デプロイメント方法

#### Docker Compose
```yaml
services:
  app:
    build: .
    ports:
      - "8080:8080"
    env_file:
      - .env
    volumes:
      - ./audio_files:/app/audio_files
```

#### 手動デプロイ
1. 依存パッケージのインストール
2. 環境変数の設定
3. uvicornでサーバー起動

## 8. セキュリティ

### 8.1 認証・認可

- APIキーによるアクセス制御
- 環境変数による機密情報管理

### 8.2 データ保護

- 一時ファイルの自動削除
- トークン使用量の制限
- CORSポリシーの設定

## 9. 今後の展開

### 9.1 開発予定機能

- ビデオ対応
- 新規プラットフォーム連携
  - Slack
  - Discord
- 新規TTSエンジン対応
  - OpenAI
  - Style-Bert-VITS2
- OpenAI Whisper対応

### 9.2 改善予定項目

- パフォーマンス最適化
- スケーラビリティ向上
- モニタリング機能強化
- テスト自動化

## 10. 運用管理

### 10.1 現在の運用機能

#### 10.1.1 ログ管理
- FastAPIの標準ログ機能を使用
  ```python
  logging.basicConfig(
      level=logging.INFO,
  )
  ```
- 主なログ出力
  - APIリクエスト・レスポンス
  - エラー情報
  - デバッグ情報（開発時）

#### 10.1.2 エラーハンドリング
- 例外処理による基本的なエラー制御
- FastAPIの標準エラーレスポンス
- Redis接続エラーのハンドリング

### 10.2 将来的な運用機能（計画中）

#### 10.2.1 拡張予定の監視機能
- 詳細なメトリクス収集
- パフォーマンスモニタリング
- アラート設定

#### 10.2.2 スケーラビリティ対応
- 複数インスタンス対応
- Redis設定の最適化
- キャッシュ戦略の実装

#### 10.2.3 バックアップ戦略
- 会話履歴のバックアップ
- 設定管理の改善
- 障害復旧手順の整備